#!/bin/sh
# This is a script for developers with repo access to generate rpm from bare checkouts.
# It replaces (i.e. violates, of necessity) the normal split-responsibility model of
# 1) project release ready to use source tar ball where ./configure is working.
# 2) independent product packager/distribution manager/vendor adds in spec file wisdom/value.
# This leads to some Rube Goldbergism, as should be expected.
# 
# It is specific to the way we run on certain DOE machines.
# You are free to copy it to other names and tune it to your systems.
# You may also need to make your own (differently named) ./util/release_tarball-300-rhine.sh
# replacement, in particular if you want to pull a specific repository branch.
# Please note:
# configuration options later in this scripts affect the source tar ball generated.
#
# correct checkout tests:
bad=0
if ! test -f gpcd-support/configure.ac; then
	echo "you need to get gpcd in place before running this. try:"
	echo "git submodule init gpcd-support"
	echo "git submodule update gpcd-support"
	echo "or copying manually to populate gpcd-support/"
	bad=1
fi
# cheesy tests, very suse/cray specific
# These duplicate (a bad idea) part of the BuildRequires of a spec file.
echo "Some rough checks that requires are satisfied. These are:"
grep Requires packaging/ovis-rhine.spec.in |grep python-base
required_files="
/usr/include/yaml.h
/usr/lib64/libyaml.so
/usr/include/event2/thread.h
/usr/lib64/libevent.so
/usr/share/gettext/config.rpath
/usr/include/openssl/md5.h
/usr/include/python2.7/Python.h
/usr/share/swig/2.0.12/python/cstring.i
"
for i in $required_files; do
	if ! test -f $i; then
		echo "missing $i. install needed package(s)"
		bad=1
	fi
done
if test $bad = "1"; then
	exit
fi
./autogen.sh
./configure --enable-ssl --disable-rpath --disable-readline CC=gcc CXX=g++ --disable-sos --enable-swig --with-pkglibdir=ovis-ldms --enable-gpcdlocal --enable-aries-mmr
mkdir -p Release
rm -rf Release/*
./util/release_tarball-300-rhine-nosos.sh
cd Release
echo "============================= bundle done ============="
tar zxf ovis-3.3.2.tar.gz
cd ovis-3.3.2
echo "============================= configure for cray sles 12 rpms ============="
./configure --enable-ssl --disable-rpath --disable-readline CC=gcc CXX=g++ --disable-sos --enable-swig --with-pkglibdir=ovis-ldms  --enable-gpcdlocal --enable-aries-mmr
echo "============================= make rhine rpms ============="
make rhine
